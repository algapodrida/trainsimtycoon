<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÇ Train Tycoon - Simulador de Maquinista</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --coal-black: #1a1a1a;
            --rust-orange: #ff6b35;
            --steel-gray: #3d5a80;
            --brass-gold: #ffb627;
            --smoke-white: #f0f0f0;
            --rail-silver: #98c1d9;
        }

        body {
            font-family: 'Courier Prime', monospace;
            background: linear-gradient(135deg, var(--coal-black) 0%, #2c2c2c 100%);
            color: var(--smoke-white);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(255,255,255,0.02) 2px, rgba(255,255,255,0.02) 4px),
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(255,255,255,0.02) 2px, rgba(255,255,255,0.02) 4px);
            pointer-events: none;
            z-index: 1;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 2;
        }

        header {
            text-align: center;
            padding: 30px 20px;
            background: linear-gradient(135deg, var(--steel-gray), var(--coal-black));
            border: 3px solid var(--rust-orange);
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(255, 107, 53, 0.3), inset 0 0 20px rgba(0,0,0,0.5);
            margin-bottom: 30px;
            animation: slideDown 0.8s ease-out;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 3.5em;
            font-weight: 900;
            color: var(--brass-gold);
            text-shadow: 
                3px 3px 0 var(--rust-orange),
                6px 6px 10px rgba(0,0,0,0.8);
            letter-spacing: 3px;
            margin-bottom: 10px;
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from {
                text-shadow: 
                    3px 3px 0 var(--rust-orange),
                    6px 6px 10px rgba(0,0,0,0.8),
                    0 0 20px rgba(255, 182, 39, 0.3);
            }
            to {
                text-shadow: 
                    3px 3px 0 var(--rust-orange),
                    6px 6px 10px rgba(0,0,0,0.8),
                    0 0 40px rgba(255, 182, 39, 0.6);
            }
        }

        .subtitle {
            font-size: 1.2em;
            color: var(--rail-silver);
            letter-spacing: 2px;
        }

        .game-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .panel {
            background: linear-gradient(145deg, #2c2c2c, #1a1a1a);
            border: 2px solid var(--steel-gray);
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5), inset 0 2px 4px rgba(255,255,255,0.1);
            animation: fadeIn 1s ease-out backwards;
        }

        .panel:nth-child(1) { animation-delay: 0.2s; }
        .panel:nth-child(2) { animation-delay: 0.4s; }
        .panel:nth-child(3) { animation-delay: 0.6s; }
        .panel:nth-child(4) { animation-delay: 0.8s; }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .panel h2 {
            font-family: 'Orbitron', sans-serif;
            color: var(--rust-orange);
            font-size: 1.8em;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--steel-gray);
            padding-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 12px 0;
            padding: 10px;
            background: rgba(61, 90, 128, 0.2);
            border-left: 4px solid var(--brass-gold);
            transition: all 0.3s ease;
        }

        .stat:hover {
            background: rgba(61, 90, 128, 0.4);
            border-left-width: 8px;
            transform: translateX(5px);
        }

        .stat-label {
            font-weight: 700;
            color: var(--rail-silver);
            font-size: 1.1em;
        }

        .stat-value {
            font-size: 1.3em;
            color: var(--brass-gold);
            font-weight: 700;
            text-shadow: 0 0 10px rgba(255, 182, 39, 0.5);
        }

        .train-display {
            text-align: center;
            font-size: 5em;
            margin: 20px 0;
            animation: chugChug 2s ease-in-out infinite;
        }

        @keyframes chugChug {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .btn {
            background: linear-gradient(145deg, var(--rust-orange), #d95424);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            border-radius: 5px;
            margin: 5px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.4);
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transform: translate(-50%, -50%);
            transition: width 0.5s, height 0.5s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 107, 53, 0.6);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: 0 3px 10px rgba(255, 107, 53, 0.4);
        }

        .btn:disabled {
            background: linear-gradient(145deg, #666, #444);
            cursor: not-allowed;
            box-shadow: none;
        }

        .btn-secondary {
            background: linear-gradient(145deg, var(--steel-gray), #2c4559);
        }

        .btn-secondary:hover {
            box-shadow: 0 8px 25px rgba(61, 90, 128, 0.6);
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .upgrade-item {
            background: rgba(255, 182, 39, 0.1);
            border: 2px solid var(--brass-gold);
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            transition: all 0.3s ease;
        }

        .upgrade-item:hover {
            background: rgba(255, 182, 39, 0.2);
            transform: scale(1.02);
            box-shadow: 0 5px 20px rgba(255, 182, 39, 0.3);
        }

        .upgrade-title {
            font-size: 1.2em;
            color: var(--brass-gold);
            margin-bottom: 8px;
            font-weight: 700;
        }

        .upgrade-cost {
            color: var(--rail-silver);
            font-size: 0.95em;
        }

        .progress-bar {
            background: rgba(61, 90, 128, 0.3);
            height: 25px;
            border-radius: 12px;
            overflow: hidden;
            margin: 15px 0;
            border: 2px solid var(--steel-gray);
        }

        .progress-fill {
            background: linear-gradient(90deg, var(--brass-gold), var(--rust-orange));
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            box-shadow: 0 0 20px rgba(255, 182, 39, 0.6);
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .journey-log {
            max-height: 200px;
            overflow-y: auto;
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 5px;
            border: 1px solid var(--steel-gray);
        }

        .journey-log::-webkit-scrollbar {
            width: 10px;
        }

        .journey-log::-webkit-scrollbar-track {
            background: rgba(61, 90, 128, 0.2);
            border-radius: 5px;
        }

        .journey-log::-webkit-scrollbar-thumb {
            background: var(--rust-orange);
            border-radius: 5px;
        }

        .log-entry {
            padding: 8px;
            margin: 5px 0;
            border-left: 3px solid var(--brass-gold);
            background: rgba(255, 182, 39, 0.05);
            animation: logSlide 0.5s ease-out;
        }

        @keyframes logSlide {
            from {
                transform: translateX(-20px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .achievement {
            background: linear-gradient(145deg, var(--brass-gold), #d99f1c);
            color: var(--coal-black);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 700;
            text-align: center;
            box-shadow: 0 5px 20px rgba(255, 182, 39, 0.5);
            animation: achievementPop 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes achievementPop {
            0% {
                transform: scale(0) rotate(-180deg);
                opacity: 0;
            }
            50% {
                transform: scale(1.1) rotate(10deg);
            }
            100% {
                transform: scale(1) rotate(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .game-grid {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2.5em;
            }
            
            .train-display {
                font-size: 3em;
            }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(145deg, var(--rust-orange), #d95424);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(255, 107, 53, 0.6);
            z-index: 1000;
            animation: slideInRight 0.5s ease-out;
            font-weight: 700;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Estilos del minijuego de conducci√≥n */
        .game-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease-out;
        }

        .game-overlay.active {
            display: flex;
        }

        .driving-game {
            width: 90%;
            max-width: 900px;
            background: linear-gradient(145deg, #2c2c2c, #1a1a1a);
            border: 3px solid var(--rust-orange);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 10px 50px rgba(255, 107, 53, 0.5);
            position: relative;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--steel-gray);
        }

        .game-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8em;
            color: var(--brass-gold);
        }

        .game-stats {
            display: flex;
            gap: 20px;
        }

        .game-stat {
            text-align: center;
        }

        .game-stat-label {
            font-size: 0.9em;
            color: var(--rail-silver);
        }

        .game-stat-value {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--brass-gold);
        }

        .track-container {
            background: #1a2a1a;
            border: 3px solid var(--steel-gray);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 600px;
        }

        .circuit-track {
            width: 700px;
            height: 550px;
            position: relative;
            background: radial-gradient(circle at center, #2a3a2a 0%, #1a2a1a 100%);
            border-radius: 8px;
        }

        /* Canvas para dibujar la ruta */
        #trackCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .track-markings {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                repeating-linear-gradient(
                    90deg,
                    transparent 0px,
                    transparent 40px,
                    rgba(152, 193, 217, 0.05) 40px,
                    rgba(152, 193, 217, 0.05) 42px
                ),
                repeating-linear-gradient(
                    0deg,
                    transparent 0px,
                    transparent 40px,
                    rgba(152, 193, 217, 0.05) 40px,
                    rgba(152, 193, 217, 0.05) 42px
                );
            z-index: 0;
        }

        .train-sprite {
            position: absolute;
            font-size: 2.5em;
            transition: none;
            filter: drop-shadow(0 5px 15px rgba(255, 107, 53, 0.8));
            z-index: 100;
            transform-origin: center center;
        }

        .station {
            position: absolute;
            width: 50px;
            height: 50px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .station-icon {
            font-size: 2em;
            filter: drop-shadow(0 0 10px rgba(152, 193, 217, 0.8));
        }

        .station-label {
            font-size: 0.7em;
            color: var(--rail-silver);
            margin-top: 3px;
            font-weight: 700;
            background: rgba(0, 0, 0, 0.7);
            padding: 2px 6px;
            border-radius: 3px;
            white-space: nowrap;
        }

        .station.next {
            animation: stationPulse 1s ease-in-out infinite;
        }

        @keyframes stationPulse {
            0%, 100% { 
                transform: scale(1);
                filter: drop-shadow(0 0 10px rgba(255, 182, 39, 0.8));
            }
            50% { 
                transform: scale(1.3);
                filter: drop-shadow(0 0 20px rgba(255, 182, 39, 1));
            }
        }

        .station.completed .station-icon {
            opacity: 0.4;
            filter: grayscale(100%) drop-shadow(0 0 5px rgba(152, 193, 217, 0.4));
        }

        .station.completed .station-label {
            text-decoration: line-through;
        }

        .stop-zone {
            position: absolute;
            width: 90px;
            height: 90px;
            border: 3px dashed var(--brass-gold);
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255, 182, 39, 0.2) 0%, transparent 70%);
            margin-left: -45px;
            margin-top: -45px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 5;
        }

        .stop-zone.active {
            opacity: 1;
            animation: zoneGlow 1s ease-in-out infinite;
        }

        @keyframes zoneGlow {
            0%, 100% { 
                box-shadow: 0 0 20px rgba(255, 182, 39, 0.5);
            }
            50% { 
                box-shadow: 0 0 40px rgba(255, 182, 39, 0.8);
            }
        }

        .controls-info {
            background: rgba(61, 90, 128, 0.2);
            border: 2px solid var(--steel-gray);
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }

        .controls-info p {
            margin: 8px 0;
            color: var(--rail-silver);
        }

        .control-key {
            display: inline-block;
            background: linear-gradient(145deg, var(--rust-orange), #d95424);
            color: white;
            padding: 5px 15px;
            border-radius: 5px;
            font-weight: 700;
            margin: 0 5px;
            font-family: 'Orbitron', sans-serif;
            box-shadow: 0 3px 10px rgba(255, 107, 53, 0.4);
        }

        .speed-meter {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 15px 0;
        }

        .speed-bar-container {
            flex: 1;
            background: rgba(61, 90, 128, 0.3);
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            border: 2px solid var(--steel-gray);
        }

        .speed-bar {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, var(--brass-gold), var(--rust-orange));
            width: 0%;
            transition: width 0.2s ease;
            box-shadow: 0 0 20px rgba(255, 182, 39, 0.6);
        }

        .speed-text {
            font-size: 1.3em;
            font-weight: 700;
            color: var(--brass-gold);
            min-width: 120px;
            text-align: center;
        }

        .game-message {
            text-align: center;
            font-size: 1.2em;
            color: var(--brass-gold);
            margin: 15px 0;
            min-height: 30px;
            font-weight: 700;
        }

        .close-game-btn {
            background: linear-gradient(145deg, var(--rust-orange), #d95424);
            position: absolute;
            top: 20px;
            right: 20px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 2px solid var(--brass-gold);
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1000;
            font-weight: 700;
        }

        .close-game-btn:hover {
            background: linear-gradient(145deg, #d95424, var(--rust-orange));
            transform: rotate(90deg) scale(1.1);
            box-shadow: 0 0 20px rgba(255, 107, 53, 0.8);
        }

        /* Sistema de guardado */
        .save-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 3000;
            display: none;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease-out;
        }

        .save-menu-overlay.active {
            display: flex;
        }

        .save-menu {
            background: linear-gradient(145deg, #2c2c2c, #1a1a1a);
            border: 3px solid var(--rust-orange);
            border-radius: 10px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 10px 50px rgba(255, 107, 53, 0.5);
        }

        .save-menu h2 {
            font-family: 'Orbitron', sans-serif;
            color: var(--brass-gold);
            font-size: 2em;
            margin-bottom: 20px;
            text-align: center;
        }

        .save-slots {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 20px 0;
        }

        .save-slot {
            background: rgba(61, 90, 128, 0.2);
            border: 2px solid var(--steel-gray);
            border-radius: 8px;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .save-slot:hover {
            background: rgba(61, 90, 128, 0.3);
            border-color: var(--brass-gold);
            transform: translateX(5px);
        }

        .save-slot-info {
            flex: 1;
        }

        .save-slot-title {
            font-family: 'Orbitron', sans-serif;
            color: var(--brass-gold);
            font-size: 1.3em;
            margin-bottom: 8px;
        }

        .save-slot-empty {
            color: var(--rail-silver);
            font-style: italic;
        }

        .save-slot-data {
            color: var(--rail-silver);
            font-size: 0.9em;
            margin-top: 5px;
        }

        .save-slot-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            background: linear-gradient(145deg, var(--steel-gray), #2c4559);
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 0.9em;
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(61, 90, 128, 0.4);
        }

        .btn-small:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(61, 90, 128, 0.6);
        }

        .btn-danger {
            background: linear-gradient(145deg, #c62828, #b71c1c);
        }

        .btn-danger:hover {
            box-shadow: 0 5px 15px rgba(198, 40, 40, 0.6);
        }

        .save-menu-close {
            text-align: center;
            margin-top: 20px;
        }

        /* Contador de vueltas en el juego */
        .lap-counter {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px 25px;
            border-radius: 8px;
            border: 2px solid var(--brass-gold);
            z-index: 150;
        }

        .lap-counter-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 2em;
            color: var(--brass-gold);
            text-align: center;
            text-shadow: 0 0 10px rgba(255, 182, 39, 0.6);
        }

        .lap-counter-label {
            font-size: 0.8em;
            color: var(--rail-silver);
            text-align: center;
            margin-top: 5px;
        }

        /* Bot√≥n de guardar en panel de acciones */
        .save-load-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        /* Animaci√≥n para las vueltas */
        @keyframes lapComplete {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.3);
                color: var(--rust-orange);
            }
            100% {
                transform: scale(1);
            }
        }

        .lap-complete-animation {
            animation: lapComplete 0.6s ease-out;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üöÇ TRAIN TYCOON</h1>
            <p class="subtitle">SIMULADOR DE MAQUINISTA</p>
        </header>

        <div class="game-grid">
            <!-- Panel de Recursos -->
            <div class="panel">
                <h2>üí∞ Recursos</h2>
                <div class="stat">
                    <span class="stat-label">Dinero:</span>
                    <span class="stat-value" id="money">$0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Dinero/seg:</span>
                    <span class="stat-value" id="moneyPerSecond">$0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Viajes Totales:</span>
                    <span class="stat-value" id="totalTrips">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Pasajeros Transportados:</span>
                    <span class="stat-value" id="totalPassengers">0</span>
                </div>
            </div>

            <!-- Panel de Tren -->
            <div class="panel">
                <h2>üöÇ Tu Tren</h2>
                <div class="train-display">üöÇ</div>
                <div class="stat">
                    <span class="stat-label">Velocidad:</span>
                    <span class="stat-value" id="speed">50 km/h</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Capacidad:</span>
                    <span class="stat-value" id="capacity">100 pasajeros</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Nivel:</span>
                    <span class="stat-value" id="trainLevel">1</span>
                </div>
            </div>

            <!-- Panel de Acciones -->
            <div class="panel">
                <h2>‚öôÔ∏è Acciones</h2>
                <div class="button-group">
                    <button class="btn" id="driveBtn" onclick="startTrip()">
                        üöÇ CONDUCIR TREN
                    </button>
                    <button class="btn btn-secondary" onclick="autoTrip()">
                        ü§ñ Auto-Piloto ($500)
                    </button>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="tripProgress"></div>
                </div>
                <div id="tripStatus" style="text-align: center; margin-top: 10px; color: var(--rail-silver);">
                    Listo para partir
                </div>
                <div class="save-load-buttons">
                    <button class="btn btn-secondary" onclick="openSaveMenu('save')" style="flex: 1;">
                        üíæ Guardar Partida
                    </button>
                    <button class="btn btn-secondary" onclick="openSaveMenu('load')" style="flex: 1;">
                        üìÇ Cargar Partida
                    </button>
                </div>
            </div>

            <!-- Panel de Mejoras -->
            <div class="panel">
                <h2>‚¨ÜÔ∏è Mejoras</h2>
                <div class="upgrade-item">
                    <div class="upgrade-title">üöÑ Mejorar Velocidad</div>
                    <div class="upgrade-cost">Costo: $<span id="speedCost">100</span></div>
                    <button class="btn btn-secondary" onclick="upgradeSpeed()">Comprar</button>
                </div>
                <div class="upgrade-item">
                    <div class="upgrade-title">üë• Ampliar Capacidad</div>
                    <div class="upgrade-cost">Costo: $<span id="capacityCost">150</span></div>
                    <button class="btn btn-secondary" onclick="upgradeCapacity()">Comprar</button>
                </div>
                <div class="upgrade-item">
                    <div class="upgrade-title">‚≠ê Mejorar Tren</div>
                    <div class="upgrade-cost">Costo: $<span id="trainCost">500</span></div>
                    <button class="btn btn-secondary" onclick="upgradeTrain()">Comprar</button>
                </div>
            </div>
        </div>

        <!-- Registro de Viajes -->
        <div class="panel">
            <h2>üìú Registro de Viajes</h2>
            <div class="journey-log" id="journeyLog">
                <div class="log-entry">¬°Bienvenido a Train Tycoon! Comienza tu carrera como maquinista.</div>
            </div>
        </div>
    </div>

    <!-- Overlay del minijuego de conducci√≥n -->
    <div class="game-overlay" id="gameOverlay">
        <div class="driving-game">
            <button class="close-game-btn" onclick="closeDrivingGame()" title="Salir (X)">‚úï</button>
            
            <div class="game-header">
                <div class="game-title">üöÇ MODO CONDUCCI√ìN</div>
                <div class="game-stats">
                    <div class="game-stat">
                        <div class="game-stat-label">Paradas</div>
                        <div class="game-stat-value" id="stopsCompleted">0/4</div>
                    </div>
                    <div class="game-stat">
                        <div class="game-stat-label">Bonus</div>
                        <div class="game-stat-value" id="bonusMoney">$0</div>
                    </div>
                    <div class="game-stat">
                        <div class="game-stat-label">Progreso</div>
                        <div class="game-stat-value" id="trackProgress">0%</div>
                    </div>
                </div>
            </div>

            <div class="controls-info">
                <p>
                    <span class="control-key">‚Üê</span> Frenar |
                    <span class="control-key">‚Üí</span> Acelerar |
                    <span class="control-key">ESPACIO</span> Parar en estaci√≥n |
                    <span class="control-key">X</span> Salir
                </p>
                <p style="color: var(--brass-gold); margin-top: 10px;">
                    ¬°Para en las estaciones cuando est√©s en la zona dorada! Da vueltas infinitas hasta salir con X.
                </p>
            </div>

            <div class="track-container">
                <div class="circuit-track" id="gameTrack">
                    <div class="lap-counter">
                        <div class="lap-counter-value" id="lapCounter">0</div>
                        <div class="lap-counter-label">VUELTAS</div>
                    </div>
                    <div class="track-markings"></div>
                    <canvas id="trackCanvas" width="700" height="550"></canvas>
                    <div class="train-sprite" id="trainSprite">üöÇ</div>
                </div>
            </div>

            <div class="speed-meter">
                <span class="speed-text" id="speedDisplay">0 km/h</span>
                <div class="speed-bar-container">
                    <div class="speed-bar" id="speedBar"></div>
                </div>
            </div>

            <div class="game-message" id="gameMessage">¬°Usa las flechas para acelerar/frenar y ESPACIO en las estaciones!</div>
        </div>
    </div>

    <!-- Men√∫ de guardado/carga -->
    <div class="save-menu-overlay" id="saveMenuOverlay">
        <div class="save-menu">
            <h2 id="saveMenuTitle">üíæ Guardar Partida</h2>
            <div class="save-slots" id="saveSlots">
                <!-- Slots generados din√°micamente -->
            </div>
            <div class="save-menu-close">
                <button class="btn" onclick="closeSaveMenu()">Cerrar</button>
            </div>
        </div>
    </div>

    <script>
        // Variables del juego
        let gameState = {
            money: 0,
            moneyPerSecond: 0,
            totalTrips: 0,
            totalPassengers: 0,
            speed: 50,
            capacity: 100,
            trainLevel: 1,
            speedCost: 100,
            capacityCost: 150,
            trainCost: 500,
            isOnTrip: false,
            autoPilot: false,
            autoPilotCost: 500,
            stationBonus: 50
        };

        // Variables del minijuego con circuito persistente
        let drivingGame = {
            active: false,
            progress: 0,
            currentSpeed: 0,
            targetSpeed: 0,
            maxSpeed: 100,
            stations: [],
            stopsCompleted: 0,
            totalStops: 4,
            bonusEarned: 0,
            lapsCompleted: 0,
            gameInterval: null,
            keys: {
                left: false,
                right: false,
                space: false
            },
            trackPath: [],
            trackLength: 0,
            canvas: null,
            ctx: null,
            savedTrack: null // Guardar la ruta generada
        };

        let saveMenuMode = 'save'; // 'save' o 'load'

        // Generar ruta aleatoria
        function generateRandomTrack() {
            const canvas = document.getElementById('trackCanvas');
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            drivingGame.canvas = canvas;
            drivingGame.ctx = ctx;
            
            ctx.clearRect(0, 0, width, height);
            
            const centerX = width / 2;
            const centerY = height / 2;
            const numControlPoints = 8 + Math.floor(Math.random() * 4);
            const controlPoints = [];
            
            for (let i = 0; i < numControlPoints; i++) {
                const angle = (i / numControlPoints) * Math.PI * 2;
                const radiusBase = 180 + Math.random() * 60;
                const radiusVariation = Math.sin(angle * 3) * 40;
                const radius = radiusBase + radiusVariation;
                
                const x = centerX + Math.cos(angle) * radius;
                const y = centerY + Math.sin(angle) * radius;
                
                controlPoints.push({ x, y });
            }
            
            drivingGame.trackPath = [];
            const resolution = 500;
            
            ctx.strokeStyle = 'rgba(61, 90, 128, 0.8)';
            ctx.lineWidth = 8;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.shadowBlur = 15;
            ctx.shadowColor = 'rgba(61, 90, 128, 0.5)';
            
            ctx.beginPath();
            
            for (let t = 0; t <= resolution; t++) {
                const progress = t / resolution;
                const point = getCatmullRomPoint(controlPoints, progress);
                
                drivingGame.trackPath.push(point);
                
                if (t === 0) {
                    ctx.moveTo(point.x, point.y);
                } else {
                    ctx.lineTo(point.x, point.y);
                }
            }
            
            ctx.closePath();
            ctx.stroke();
            
            ctx.strokeStyle = 'rgba(152, 193, 217, 0.4)';
            ctx.lineWidth = 2;
            ctx.setLineDash([10, 10]);
            ctx.beginPath();
            
            for (let i = 0; i < drivingGame.trackPath.length; i++) {
                const point = drivingGame.trackPath[i];
                if (i === 0) {
                    ctx.moveTo(point.x, point.y);
                } else {
                    ctx.lineTo(point.x, point.y);
                }
            }
            
            ctx.closePath();
            ctx.stroke();
            ctx.setLineDash([]);
            ctx.shadowBlur = 0;
            
            drivingGame.trackLength = drivingGame.trackPath.length;
            
            // Guardar la ruta generada
            drivingGame.savedTrack = {
                path: drivingGame.trackPath,
                length: drivingGame.trackLength
            };
        }

        // Redibujar ruta guardada
        function redrawSavedTrack() {
            if (!drivingGame.savedTrack) return;
            
            const canvas = document.getElementById('trackCanvas');
            const ctx = canvas.getContext('2d');
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            drivingGame.trackPath = drivingGame.savedTrack.path;
            drivingGame.trackLength = drivingGame.savedTrack.length;
            
            ctx.strokeStyle = 'rgba(61, 90, 128, 0.8)';
            ctx.lineWidth = 8;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.shadowBlur = 15;
            ctx.shadowColor = 'rgba(61, 90, 128, 0.5)';
            
            ctx.beginPath();
            for (let i = 0; i < drivingGame.trackPath.length; i++) {
                const point = drivingGame.trackPath[i];
                if (i === 0) {
                    ctx.moveTo(point.x, point.y);
                } else {
                    ctx.lineTo(point.x, point.y);
                }
            }
            ctx.closePath();
            ctx.stroke();
            
            ctx.strokeStyle = 'rgba(152, 193, 217, 0.4)';
            ctx.lineWidth = 2;
            ctx.setLineDash([10, 10]);
            ctx.beginPath();
            for (let i = 0; i < drivingGame.trackPath.length; i++) {
                const point = drivingGame.trackPath[i];
                if (i === 0) {
                    ctx.moveTo(point.x, point.y);
                } else {
                    ctx.lineTo(point.x, point.y);
                }
            }
            ctx.closePath();
            ctx.stroke();
            ctx.setLineDash([]);
            ctx.shadowBlur = 0;
        }

        function getCatmullRomPoint(points, t) {
            const numPoints = points.length;
            const scaledT = t * numPoints;
            const p0Index = Math.floor(scaledT) % numPoints;
            const p1Index = (p0Index + 1) % numPoints;
            const p2Index = (p0Index + 2) % numPoints;
            const p3Index = (p0Index + 3) % numPoints;
            
            const localT = scaledT - Math.floor(scaledT);
            
            const p0 = points[p0Index];
            const p1 = points[p1Index];
            const p2 = points[p2Index];
            const p3 = points[p3Index];
            
            const t2 = localT * localT;
            const t3 = t2 * localT;
            
            const x = 0.5 * (
                (2 * p1.x) +
                (-p0.x + p2.x) * localT +
                (2 * p0.x - 5 * p1.x + 4 * p2.x - p3.x) * t2 +
                (-p0.x + 3 * p1.x - 3 * p2.x + p3.x) * t3
            );
            
            const y = 0.5 * (
                (2 * p1.y) +
                (-p0.y + p2.y) * localT +
                (2 * p0.y - 5 * p1.y + 4 * p2.y - p3.y) * t2 +
                (-p0.y + 3 * p1.y - 3 * p2.y + p3.y) * t3
            );
            
            return { x, y };
        }

        function getPositionOnTrack(progress) {
            progress = Math.max(0, Math.min(1, progress));
            const index = Math.floor(progress * (drivingGame.trackPath.length - 1));
            return drivingGame.trackPath[index] || drivingGame.trackPath[0];
        }

        function getTrainRotation(progress) {
            const index = Math.floor(progress * (drivingGame.trackPath.length - 1));
            const nextIndex = (index + 1) % drivingGame.trackPath.length;
            
            const current = drivingGame.trackPath[index];
            const next = drivingGame.trackPath[nextIndex];
            
            if (!current || !next) return 0;
            
            const dx = next.x - current.x;
            const dy = next.y - current.y;
            
            return Math.atan2(dy, dx) * (180 / Math.PI);
        }

        function updateDisplay() {
            document.getElementById('money').textContent = '$' + Math.floor(gameState.money);
            document.getElementById('moneyPerSecond').textContent = '$' + gameState.moneyPerSecond.toFixed(1);
            document.getElementById('totalTrips').textContent = gameState.totalTrips;
            document.getElementById('totalPassengers').textContent = gameState.totalPassengers;
            document.getElementById('speed').textContent = gameState.speed + ' km/h';
            document.getElementById('capacity').textContent = gameState.capacity + ' pasajeros';
            document.getElementById('trainLevel').textContent = gameState.trainLevel;
            document.getElementById('speedCost').textContent = gameState.speedCost;
            document.getElementById('capacityCost').textContent = gameState.capacityCost;
            document.getElementById('trainCost').textContent = gameState.trainCost;
        }

        function startTrip() {
            if (gameState.isOnTrip) return;
            gameState.isOnTrip = true;
            openDrivingGame();
        }

        function openDrivingGame() {
            drivingGame.active = true;
            drivingGame.progress = 0;
            drivingGame.currentSpeed = 0;
            drivingGame.targetSpeed = 0;
            drivingGame.stopsCompleted = 0;
            drivingGame.bonusEarned = 0;
            drivingGame.lapsCompleted = 0;
            
            // Generar nueva ruta solo si no existe una guardada
            if (!drivingGame.savedTrack) {
                generateRandomTrack();
            } else {
                redrawSavedTrack();
            }
            
            // Crear estaciones
            drivingGame.stations = [];
            const stationPositions = [0.15, 0.35, 0.60, 0.85];
            
            for (let i = 0; i < drivingGame.totalStops; i++) {
                const basePos = stationPositions[i];
                const variation = (Math.random() - 0.5) * 0.08;
                const position = Math.max(0.05, Math.min(0.95, basePos + variation));
                
                drivingGame.stations.push({
                    position: position,
                    completed: false,
                    bonus: gameState.stationBonus * (i + 1) * gameState.trainLevel,
                    stopZone: null
                });
            }
            
            renderStations();
            
            document.getElementById('gameOverlay').classList.add('active');
            document.getElementById('gameMessage').textContent = '¬°Acelera con ‚Üí y frena con ‚Üê! Presiona X para salir.';
            document.getElementById('stopsCompleted').textContent = '0/' + drivingGame.totalStops;
            document.getElementById('bonusMoney').textContent = '$0';
            document.getElementById('trackProgress').textContent = '0%';
            document.getElementById('lapCounter').textContent = '0';
            
            drivingGame.gameInterval = setInterval(updateDrivingGame, 30);
        }

        function renderStations() {
            const track = document.getElementById('gameTrack');
            
            const oldElements = track.querySelectorAll('.station, .stop-zone');
            oldElements.forEach(el => el.remove());
            
            drivingGame.stations.forEach((station, index) => {
                const pos = getPositionOnTrack(station.position);
                
                const stationEl = document.createElement('div');
                stationEl.className = 'station';
                stationEl.style.left = pos.x + 'px';
                stationEl.style.top = pos.y + 'px';
                stationEl.style.transform = 'translate(-50%, -50%)';
                stationEl.innerHTML = `
                    <div class="station-icon">üè†</div>
                    <div class="station-label">Est. ${index + 1}</div>
                `;
                stationEl.id = 'station-' + index;
                track.appendChild(stationEl);
                
                const zoneEl = document.createElement('div');
                zoneEl.className = 'stop-zone';
                zoneEl.style.left = pos.x + 'px';
                zoneEl.style.top = pos.y + 'px';
                zoneEl.id = 'zone-' + index;
                track.appendChild(zoneEl);
                
                station.stopZone = zoneEl;
            });
            
            updateNextStation();
        }

        function updateNextStation() {
            document.querySelectorAll('.station').forEach(s => s.classList.remove('next'));
            document.querySelectorAll('.stop-zone').forEach(z => z.classList.remove('active'));
            
            const nextStation = drivingGame.stations.find(s => !s.completed);
            if (nextStation) {
                const index = drivingGame.stations.indexOf(nextStation);
                document.getElementById('station-' + index).classList.add('next');
                document.getElementById('zone-' + index).classList.add('active');
            }
        }

        function updateDrivingGame() {
            if (!drivingGame.active) return;
            
            if (drivingGame.keys.right) {
                drivingGame.targetSpeed = Math.min(drivingGame.maxSpeed, drivingGame.targetSpeed + 3);
            }
            if (drivingGame.keys.left) {
                drivingGame.targetSpeed = Math.max(0, drivingGame.targetSpeed - 3);
            }
            
            drivingGame.currentSpeed += (drivingGame.targetSpeed - drivingGame.currentSpeed) * 0.1;
            
            drivingGame.progress += drivingGame.currentSpeed * 0.0003;
            
            // Completar vuelta y continuar infinitamente
            if (drivingGame.progress >= 1) {
                drivingGame.progress = 0;
                drivingGame.lapsCompleted++;
                
                // Animar contador
                const lapCounter = document.getElementById('lapCounter');
                lapCounter.textContent = drivingGame.lapsCompleted;
                lapCounter.classList.add('lap-complete-animation');
                setTimeout(() => lapCounter.classList.remove('lap-complete-animation'), 600);
                
                // Reiniciar estaciones
                drivingGame.stations.forEach(s => s.completed = false);
                drivingGame.stopsCompleted = 0;
                renderStations();
                
                showNotification('üîÑ ¬°Vuelta ' + drivingGame.lapsCompleted + ' completada!');
            }
            
            const pos = getPositionOnTrack(drivingGame.progress);
            const rotation = getTrainRotation(drivingGame.progress);
            
            const trainSprite = document.getElementById('trainSprite');
            trainSprite.style.left = pos.x + 'px';
            trainSprite.style.top = pos.y + 'px';
            trainSprite.style.transform = `translate(-50%, -50%) rotate(${rotation}deg)`;
            
            const displaySpeed = Math.floor(drivingGame.currentSpeed * (gameState.speed / 100));
            document.getElementById('speedDisplay').textContent = displaySpeed + ' km/h';
            document.getElementById('speedBar').style.width = drivingGame.currentSpeed + '%';
            document.getElementById('trackProgress').textContent = Math.floor(drivingGame.progress * 100) + '%';
            
            checkStationStop();
        }

        function checkStationStop() {
            drivingGame.stations.forEach((station, index) => {
                if (station.completed) return;
                
                const distance = Math.abs(drivingGame.progress - station.position);
                
                if (distance < 0.03) {
                    if (drivingGame.keys.space && drivingGame.currentSpeed < 30) {
                        stopAtStation(index);
                    } else if (drivingGame.keys.space && drivingGame.currentSpeed >= 30) {
                        document.getElementById('gameMessage').textContent = '‚ö†Ô∏è ¬°Demasiado r√°pido! Frena con ‚Üê';
                    }
                }
            });
        }

        function stopAtStation(index) {
            const station = drivingGame.stations[index];
            if (station.completed) return;
            
            station.completed = true;
            drivingGame.stopsCompleted++;
            drivingGame.bonusEarned += station.bonus;
            
            document.getElementById('stopsCompleted').textContent = drivingGame.stopsCompleted + '/' + drivingGame.totalStops;
            document.getElementById('bonusMoney').textContent = '$' + Math.floor(drivingGame.bonusEarned);
            
            const stationEl = document.getElementById('station-' + index);
            stationEl.classList.remove('next');
            stationEl.classList.add('completed');
            stationEl.style.transform = 'translate(-50%, -50%) scale(1.5)';
            setTimeout(() => stationEl.style.transform = 'translate(-50%, -50%) scale(1)', 300);
            
            document.getElementById('gameMessage').textContent = '‚úÖ ¬°+$' + Math.floor(station.bonus) + ' ganados!';
            updateNextStation();
            
            drivingGame.targetSpeed = 0;
            drivingGame.currentSpeed = 0;
            
            setTimeout(() => {
                if (drivingGame.active) {
                    if (drivingGame.stopsCompleted === drivingGame.totalStops) {
                        document.getElementById('gameMessage').textContent = 'üéØ ¬°Todas las paradas! Contin√∫a o sal con X';
                    } else {
                        document.getElementById('gameMessage').textContent = 'Contin√∫a hacia la siguiente estaci√≥n';
                    }
                }
            }, 1500);
        }

        function completeDrivingGame() {
            drivingGame.active = false;
            clearInterval(drivingGame.gameInterval);
            
            const passengers = gameState.capacity * (drivingGame.lapsCompleted + 1);
            const baseEarnings = passengers * (1 + gameState.trainLevel * 0.5);
            const totalEarnings = baseEarnings + drivingGame.bonusEarned;
            
            gameState.money += totalEarnings;
            gameState.totalTrips++;
            gameState.totalPassengers += passengers;
            
            let message = `‚úÖ Viaje completado: ${drivingGame.lapsCompleted} vueltas, +${passengers} pasajeros, +$${Math.floor(baseEarnings)}`;
            if (drivingGame.bonusEarned > 0) {
                message += ` + Bonus $${Math.floor(drivingGame.bonusEarned)}`;
            }
            
            addLogEntry(message);
            
            document.getElementById('tripProgress').style.width = '0%';
            document.getElementById('tripStatus').textContent = 'Listo';
            document.getElementById('driveBtn').disabled = false;
            gameState.isOnTrip = false;
            
            updateDisplay();
            checkAchievements();
            
            setTimeout(() => closeDrivingGame(), 3000);
        }

        function closeDrivingGame() {
            if (drivingGame.active) {
                completeDrivingGame();
            }
            document.getElementById('gameOverlay').classList.remove('active');
        }

        // Control de teclado
        document.addEventListener('keydown', (e) => {
            if (!drivingGame.active) return;
            
            if (e.key === 'ArrowLeft') {
                drivingGame.keys.left = true;
                e.preventDefault();
            }
            if (e.key === 'ArrowRight') {
                drivingGame.keys.right = true;
                e.preventDefault();
            }
            if (e.key === ' ') {
                drivingGame.keys.space = true;
                e.preventDefault();
            }
            if (e.key.toLowerCase() === 'x') {
                closeDrivingGame();
                e.preventDefault();
            }
        });

        document.addEventListener('keyup', (e) => {
            if (!drivingGame.active) return;
            
            if (e.key === 'ArrowLeft') drivingGame.keys.left = false;
            if (e.key === 'ArrowRight') drivingGame.keys.right = false;
            if (e.key === ' ') drivingGame.keys.space = false;
        });

        // SISTEMA DE GUARDADO
        function openSaveMenu(mode) {
            saveMenuMode = mode;
            document.getElementById('saveMenuTitle').textContent = mode === 'save' ? 'üíæ Guardar Partida' : 'üìÇ Cargar Partida';
            renderSaveSlots();
            document.getElementById('saveMenuOverlay').classList.add('active');
        }

        function closeSaveMenu() {
            document.getElementById('saveMenuOverlay').classList.remove('active');
        }

        function renderSaveSlots() {
            const container = document.getElementById('saveSlots');
            container.innerHTML = '';
            
            for (let i = 1; i <= 3; i++) {
                const saveData = localStorage.getItem('trainTycoonSlot' + i);
                const slot = document.createElement('div');
                slot.className = 'save-slot';
                
                if (saveData) {
                    const data = JSON.parse(saveData);
                    slot.innerHTML = `
                        <div class="save-slot-info">
                            <div class="save-slot-title">Ranura ${i}</div>
                            <div class="save-slot-data">
                                üí∞ $${Math.floor(data.money)} | 
                                üöÇ Nivel ${data.trainLevel} | 
                                üéØ ${data.totalTrips} viajes
                            </div>
                            <div class="save-slot-data" style="font-size: 0.8em; opacity: 0.7;">
                                ${new Date(data.timestamp).toLocaleString()}
                            </div>
                        </div>
                        <div class="save-slot-actions">
                            ${saveMenuMode === 'save' 
                                ? `<button class="btn-small" onclick="saveGame(${i})">üíæ Guardar</button>`
                                : `<button class="btn-small" onclick="loadGame(${i})">üìÇ Cargar</button>`
                            }
                            <button class="btn-small btn-danger" onclick="deleteSave(${i})">üóëÔ∏è</button>
                        </div>
                    `;
                } else {
                    slot.innerHTML = `
                        <div class="save-slot-info">
                            <div class="save-slot-title">Ranura ${i}</div>
                            <div class="save-slot-empty">Vac√≠a</div>
                        </div>
                        <div class="save-slot-actions">
                            ${saveMenuMode === 'save' 
                                ? `<button class="btn-small" onclick="saveGame(${i})">üíæ Guardar</button>`
                                : `<button class="btn-small" disabled>üìÇ Cargar</button>`
                            }
                        </div>
                    `;
                }
                
                container.appendChild(slot);
            }
        }

        function saveGame(slot) {
            const saveData = {
                ...gameState,
                savedTrack: drivingGame.savedTrack,
                timestamp: Date.now()
            };
            
            localStorage.setItem('trainTycoonSlot' + slot, JSON.stringify(saveData));
            showNotification('üíæ Partida guardada en Ranura ' + slot);
            addLogEntry('üíæ Partida guardada en Ranura ' + slot);
            closeSaveMenu();
        }

        function loadGame(slot) {
            const saveData = localStorage.getItem('trainTycoonSlot' + slot);
            if (!saveData) return;
            
            const data = JSON.parse(saveData);
            
            // Restaurar estado del juego
            gameState.money = data.money;
            gameState.moneyPerSecond = data.moneyPerSecond;
            gameState.totalTrips = data.totalTrips;
            gameState.totalPassengers = data.totalPassengers;
            gameState.speed = data.speed;
            gameState.capacity = data.capacity;
            gameState.trainLevel = data.trainLevel;
            gameState.speedCost = data.speedCost;
            gameState.capacityCost = data.capacityCost;
            gameState.trainCost = data.trainCost;
            gameState.autoPilot = data.autoPilot;
            gameState.stationBonus = data.stationBonus;
            
            // Restaurar ruta guardada
            if (data.savedTrack) {
                drivingGame.savedTrack = data.savedTrack;
            }
            
            updateDisplay();
            showNotification('üìÇ Partida cargada de Ranura ' + slot);
            addLogEntry('üìÇ Partida cargada de Ranura ' + slot);
            closeSaveMenu();
            
            if (gameState.autoPilot && !gameState.isOnTrip) {
                startAutoTrip();
            }
        }

        function deleteSave(slot) {
            if (confirm('¬øEliminar partida guardada en Ranura ' + slot + '?')) {
                localStorage.removeItem('trainTycoonSlot' + slot);
                renderSaveSlots();
                showNotification('üóëÔ∏è Partida eliminada de Ranura ' + slot);
            }
        }

        // Auto-piloto
        function autoTrip() {
            if (gameState.money >= gameState.autoPilotCost && !gameState.autoPilot) {
                gameState.money -= gameState.autoPilotCost;
                gameState.autoPilot = true;
                gameState.moneyPerSecond = (gameState.capacity * (1 + gameState.trainLevel * 0.5)) / 5;
                
                showNotification('ü§ñ ¬°Auto-piloto activado!');
                addLogEntry('ü§ñ Auto-piloto activado');
                updateDisplay();
                
                if (!gameState.isOnTrip) startAutoTrip();
            } else if (gameState.autoPilot) {
                showNotification('‚ÑπÔ∏è Auto-piloto ya activo');
            } else {
                showNotification('‚ùå Dinero insuficiente');
            }
        }

        function startAutoTrip() {
            if (!gameState.autoPilot || gameState.isOnTrip) return;
            
            gameState.isOnTrip = true;
            document.getElementById('driveBtn').disabled = true;
            document.getElementById('tripStatus').textContent = 'ü§ñ Auto-piloto...';
            
            const tripDuration = 5000 - (gameState.speed * 10);
            const progressBar = document.getElementById('tripProgress');
            
            let progress = 0;
            const interval = setInterval(() => {
                progress += 2;
                progressBar.style.width = progress + '%';
                
                if (progress >= 100) {
                    clearInterval(interval);
                    completeAutoTrip();
                }
            }, tripDuration / 50);
        }

        function completeAutoTrip() {
            const passengers = gameState.capacity;
            const earnings = passengers * (1 + gameState.trainLevel * 0.5);
            
            gameState.money += earnings;
            gameState.totalTrips++;
            gameState.totalPassengers += passengers;
            
            addLogEntry(`ü§ñ Auto-viaje: +${passengers} pasajeros, +$${Math.floor(earnings)}`);
            
            document.getElementById('tripProgress').style.width = '0%';
            document.getElementById('tripStatus').textContent = 'Listo';
            document.getElementById('driveBtn').disabled = false;
            gameState.isOnTrip = false;
            
            updateDisplay();
            checkAchievements();
            
            if (gameState.autoPilot) setTimeout(startAutoTrip, 1000);
        }

        // Mejoras
        function upgradeSpeed() {
            if (gameState.money >= gameState.speedCost) {
                gameState.money -= gameState.speedCost;
                gameState.speed += 10;
                gameState.speedCost = Math.floor(gameState.speedCost * 1.5);
                addLogEntry(`üöÑ Velocidad: ${gameState.speed} km/h`);
                showNotification('üöÑ ¬°Velocidad mejorada!');
                updateDisplay();
            } else {
                showNotification('‚ùå Dinero insuficiente');
            }
        }

        function upgradeCapacity() {
            if (gameState.money >= gameState.capacityCost) {
                gameState.money -= gameState.capacityCost;
                gameState.capacity += 50;
                gameState.capacityCost = Math.floor(gameState.capacityCost * 1.5);
                
                if (gameState.autoPilot) {
                    gameState.moneyPerSecond = (gameState.capacity * (1 + gameState.trainLevel * 0.5)) / 5;
                }
                
                addLogEntry(`üë• Capacidad: ${gameState.capacity}`);
                showNotification('üë• ¬°Capacidad aumentada!');
                updateDisplay();
            } else {
                showNotification('‚ùå Dinero insuficiente');
            }
        }

        function upgradeTrain() {
            if (gameState.money >= gameState.trainCost) {
                gameState.money -= gameState.trainCost;
                gameState.trainLevel++;
                gameState.trainCost = Math.floor(gameState.trainCost * 2);
                gameState.stationBonus = 50 * gameState.trainLevel;
                
                if (gameState.autoPilot) {
                    gameState.moneyPerSecond = (gameState.capacity * (1 + gameState.trainLevel * 0.5)) / 5;
                }
                
                addLogEntry(`‚≠ê Tren nivel ${gameState.trainLevel}`);
                showNotification(`‚≠ê ¬°Nivel ${gameState.trainLevel}!`);
                updateDisplay();
            } else {
                showNotification('‚ùå Dinero insuficiente');
            }
        }

        function addLogEntry(text) {
            const log = document.getElementById('journeyLog');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = text;
            log.insertBefore(entry, log.firstChild);
            if (log.children.length > 20) log.removeChild(log.lastChild);
        }

        function showNotification(text) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = text;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideInRight 0.5s ease-out reverse';
                setTimeout(() => notification.remove(), 500);
            }, 2500);
        }

        function checkAchievements() {
            if (gameState.totalTrips === 10) showNotification('üèÜ 10 viajes!');
            if (gameState.totalTrips === 50) showNotification('üèÜ 50 viajes!');
            if (gameState.totalTrips === 100) showNotification('üèÜ ¬°Maquinista Experto!');
            if (gameState.totalPassengers >= 1000) showNotification('üèÜ 1000 pasajeros!');
            if (gameState.trainLevel === 5) showNotification('üèÜ Tren de Alta Tecnolog√≠a!');
        }

        updateDisplay();
    </script>

        // Generar ruta aleatoria con curvas suaves
        function generateRandomTrack() {
            const canvas = document.getElementById('trackCanvas');
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            drivingGame.canvas = canvas;
            drivingGame.ctx = ctx;
            
            // Limpiar canvas
            ctx.clearRect(0, 0, width, height);
            
            // Generar puntos de control para una ruta cerrada compleja
            const centerX = width / 2;
            const centerY = height / 2;
            const numControlPoints = 8 + Math.floor(Math.random() * 4); // 8-11 puntos
            const controlPoints = [];
            
            // Generar puntos distribuidos alrededor del centro con variaci√≥n aleatoria
            for (let i = 0; i < numControlPoints; i++) {
                const angle = (i / numControlPoints) * Math.PI * 2;
                const radiusBase = 180 + Math.random() * 60; // Radio variable
                const radiusVariation = Math.sin(angle * 3) * 40; // Variaci√≥n sinusoidal
                const radius = radiusBase + radiusVariation;
                
                const x = centerX + Math.cos(angle) * radius;
                const y = centerY + Math.sin(angle) * radius;
                
                controlPoints.push({ x, y });
            }
            
            // Dibujar la ruta usando curvas Catmull-Rom para suavidad
            drivingGame.trackPath = [];
            const resolution = 500; // Puntos para la ruta (m√°s = m√°s preciso)
            
            ctx.strokeStyle = 'rgba(61, 90, 128, 0.8)';
            ctx.lineWidth = 8;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.shadowBlur = 15;
            ctx.shadowColor = 'rgba(61, 90, 128, 0.5)';
            
            ctx.beginPath();
            
            // Generar curva suave a trav√©s de todos los puntos de control
            for (let t = 0; t <= resolution; t++) {
                const progress = t / resolution;
                const point = getCatmullRomPoint(controlPoints, progress);
                
                drivingGame.trackPath.push(point);
                
                if (t === 0) {
                    ctx.moveTo(point.x, point.y);
                } else {
                    ctx.lineTo(point.x, point.y);
                }
            }
            
            ctx.closePath();
            ctx.stroke();
            
            // Dibujar l√≠nea central discontinua
            ctx.strokeStyle = 'rgba(152, 193, 217, 0.4)';
            ctx.lineWidth = 2;
            ctx.setLineDash([10, 10]);
            ctx.beginPath();
            
            for (let i = 0; i < drivingGame.trackPath.length; i++) {
                const point = drivingGame.trackPath[i];
                if (i === 0) {
                    ctx.moveTo(point.x, point.y);
                } else {
                    ctx.lineTo(point.x, point.y);
                }
            }
            
            ctx.closePath();
            ctx.stroke();
            ctx.setLineDash([]);
            ctx.shadowBlur = 0;
            
            // Calcular longitud total de la ruta
            drivingGame.trackLength = drivingGame.trackPath.length;
        }

        // Interpolaci√≥n Catmull-Rom para curvas suaves
        function getCatmullRomPoint(points, t) {
            const numPoints = points.length;
            const scaledT = t * numPoints;
            const p0Index = Math.floor(scaledT) % numPoints;
            const p1Index = (p0Index + 1) % numPoints;
            const p2Index = (p0Index + 2) % numPoints;
            const p3Index = (p0Index + 3) % numPoints;
            
            const localT = scaledT - Math.floor(scaledT);
            
            const p0 = points[p0Index];
            const p1 = points[p1Index];
            const p2 = points[p2Index];
            const p3 = points[p3Index];
            
            const t2 = localT * localT;
            const t3 = t2 * localT;
            
            const x = 0.5 * (
                (2 * p1.x) +
                (-p0.x + p2.x) * localT +
                (2 * p0.x - 5 * p1.x + 4 * p2.x - p3.x) * t2 +
                (-p0.x + 3 * p1.x - 3 * p2.x + p3.x) * t3
            );
            
            const y = 0.5 * (
                (2 * p1.y) +
                (-p0.y + p2.y) * localT +
                (2 * p0.y - 5 * p1.y + 4 * p2.y - p3.y) * t2 +
                (-p0.y + 3 * p1.y - 3 * p2.y + p3.y) * t3
            );
            
            return { x, y };
        }

        // Obtener posici√≥n en la ruta seg√∫n el progreso
        function getPositionOnTrack(progress) {
            progress = Math.max(0, Math.min(1, progress)); // Limitar entre 0 y 1
            const index = Math.floor(progress * (drivingGame.trackPath.length - 1));
            return drivingGame.trackPath[index] || drivingGame.trackPath[0];
        }

        // Calcular √°ngulo de rotaci√≥n del tren
        function getTrainRotation(progress) {
            const index = Math.floor(progress * (drivingGame.trackPath.length - 1));
            const nextIndex = (index + 1) % drivingGame.trackPath.length;
            
            const current = drivingGame.trackPath[index];
            const next = drivingGame.trackPath[nextIndex];
            
            if (!current || !next) return 0;
            
            const dx = next.x - current.x;
            const dy = next.y - current.y;
            
            return Math.atan2(dy, dx) * (180 / Math.PI);
        }

        // Actualizar visualizaci√≥n
        function updateDisplay() {
            document.getElementById('money').textContent = '$' + Math.floor(gameState.money);
            document.getElementById('moneyPerSecond').textContent = '$' + gameState.moneyPerSecond.toFixed(1);
            document.getElementById('totalTrips').textContent = gameState.totalTrips;
            document.getElementById('totalPassengers').textContent = gameState.totalPassengers;
            document.getElementById('speed').textContent = gameState.speed + ' km/h';
            document.getElementById('capacity').textContent = gameState.capacity + ' pasajeros';
            document.getElementById('trainLevel').textContent = gameState.trainLevel;
            document.getElementById('speedCost').textContent = gameState.speedCost;
            document.getElementById('capacityCost').textContent = gameState.capacityCost;
            document.getElementById('trainCost').textContent = gameState.trainCost;
        }

        // Iniciar viaje
        function startTrip() {
            if (gameState.isOnTrip) return;
            gameState.isOnTrip = true;
            openDrivingGame();
        }

        // Abrir minijuego de conducci√≥n
        function openDrivingGame() {
            drivingGame.active = true;
            drivingGame.progress = 0;
            drivingGame.currentSpeed = 0;
            drivingGame.targetSpeed = 0;
            drivingGame.stopsCompleted = 0;
            drivingGame.bonusEarned = 0;
            
            // Generar ruta aleatoria
            generateRandomTrack();
            
            // Crear estaciones en posiciones equilibradas
            drivingGame.stations = [];
            const stationPositions = [0.15, 0.35, 0.60, 0.85]; // Posiciones a lo largo de la ruta
            
            for (let i = 0; i < drivingGame.totalStops; i++) {
                const basePos = stationPositions[i];
                const variation = (Math.random() - 0.5) * 0.08; // Variaci√≥n aleatoria
                const position = Math.max(0.05, Math.min(0.95, basePos + variation));
                
                drivingGame.stations.push({
                    position: position,
                    completed: false,
                    bonus: gameState.stationBonus * (i + 1) * gameState.trainLevel,
                    stopZone: null
                });
            }
            
            renderStations();
            
            document.getElementById('gameOverlay').classList.add('active');
            document.getElementById('gameMessage').textContent = '¬°Acelera con ‚Üí y frena con ‚Üê! Usa ESPACIO en las estaciones.';
            document.getElementById('stopsCompleted').textContent = '0/' + drivingGame.totalStops;
            document.getElementById('bonusMoney').textContent = '$0';
            document.getElementById('trackProgress').textContent = '0%';
            
            // Iniciar loop del juego
            drivingGame.gameInterval = setInterval(updateDrivingGame, 30);
        }

        // Renderizar estaciones
        function renderStations() {
            const track = document.getElementById('gameTrack');
            
            // Limpiar elementos existentes
            const oldElements = track.querySelectorAll('.station, .stop-zone');
            oldElements.forEach(el => el.remove());
            
            // Crear estaciones
            drivingGame.stations.forEach((station, index) => {
                const pos = getPositionOnTrack(station.position);
                
                // Crear estaci√≥n
                const stationEl = document.createElement('div');
                stationEl.className = 'station';
                stationEl.style.left = pos.x + 'px';
                stationEl.style.top = pos.y + 'px';
                stationEl.style.transform = 'translate(-50%, -50%)';
                stationEl.innerHTML = `
                    <div class="station-icon">üè†</div>
                    <div class="station-label">Est. ${index + 1}</div>
                `;
                stationEl.id = 'station-' + index;
                track.appendChild(stationEl);
                
                // Crear zona de parada
                const zoneEl = document.createElement('div');
                zoneEl.className = 'stop-zone';
                zoneEl.style.left = pos.x + 'px';
                zoneEl.style.top = pos.y + 'px';
                zoneEl.id = 'zone-' + index;
                track.appendChild(zoneEl);
                
                station.stopZone = zoneEl;
            });
            
            updateNextStation();
        }

        // Actualizar siguiente estaci√≥n
        function updateNextStation() {
            document.querySelectorAll('.station').forEach(s => s.classList.remove('next'));
            document.querySelectorAll('.stop-zone').forEach(z => z.classList.remove('active'));
            
            const nextStation = drivingGame.stations.find(s => !s.completed);
            if (nextStation) {
                const index = drivingGame.stations.indexOf(nextStation);
                document.getElementById('station-' + index).classList.add('next');
                document.getElementById('zone-' + index).classList.add('active');
            }
        }

        // Loop del minijuego
        function updateDrivingGame() {
            if (!drivingGame.active) return;
            
            // Actualizar velocidad
            if (drivingGame.keys.right) {
                drivingGame.targetSpeed = Math.min(drivingGame.maxSpeed, drivingGame.targetSpeed + 3);
            }
            if (drivingGame.keys.left) {
                drivingGame.targetSpeed = Math.max(0, drivingGame.targetSpeed - 3);
            }
            
            drivingGame.currentSpeed += (drivingGame.targetSpeed - drivingGame.currentSpeed) * 0.1;
            
            // Mover tren por la ruta
            drivingGame.progress += drivingGame.currentSpeed * 0.0003;
            
            // Completar vuelta
            if (drivingGame.progress >= 1) {
                completeDrivingGame();
                return;
            }
            
            // Actualizar posici√≥n del tren
            const pos = getPositionOnTrack(drivingGame.progress);
            const rotation = getTrainRotation(drivingGame.progress);
            
            const trainSprite = document.getElementById('trainSprite');
            trainSprite.style.left = pos.x + 'px';
            trainSprite.style.top = pos.y + 'px';
            trainSprite.style.transform = `translate(-50%, -50%) rotate(${rotation}deg)`;
            
            // Actualizar UI
            const displaySpeed = Math.floor(drivingGame.currentSpeed * (gameState.speed / 100));
            document.getElementById('speedDisplay').textContent = displaySpeed + ' km/h';
            document.getElementById('speedBar').style.width = drivingGame.currentSpeed + '%';
            document.getElementById('trackProgress').textContent = Math.floor(drivingGame.progress * 100) + '%';
            
            checkStationStop();
        }

        // Verificar paradas
        function checkStationStop() {
            drivingGame.stations.forEach((station, index) => {
                if (station.completed) return;
                
                const distance = Math.abs(drivingGame.progress - station.position);
                
                if (distance < 0.03) { // Cerca de la estaci√≥n
                    if (drivingGame.keys.space && drivingGame.currentSpeed < 30) {
                        stopAtStation(index);
                    } else if (drivingGame.keys.space && drivingGame.currentSpeed >= 30) {
                        document.getElementById('gameMessage').textContent = '‚ö†Ô∏è ¬°Demasiado r√°pido! Frena con ‚Üê';
                    }
                }
            });
        }

        // Parar en estaci√≥n
        function stopAtStation(index) {
            const station = drivingGame.stations[index];
            if (station.completed) return;
            
            station.completed = true;
            drivingGame.stopsCompleted++;
            drivingGame.bonusEarned += station.bonus;
            
            document.getElementById('stopsCompleted').textContent = drivingGame.stopsCompleted + '/' + drivingGame.totalStops;
            document.getElementById('bonusMoney').textContent = '$' + Math.floor(drivingGame.bonusEarned);
            
            const stationEl = document.getElementById('station-' + index);
            stationEl.classList.remove('next');
            stationEl.classList.add('completed');
            stationEl.style.transform = 'translate(-50%, -50%) scale(1.5)';
            setTimeout(() => stationEl.style.transform = 'translate(-50%, -50%) scale(1)', 300);
            
            document.getElementById('gameMessage').textContent = '‚úÖ ¬°+$' + Math.floor(station.bonus) + ' ganados!';
            updateNextStation();
            
            drivingGame.targetSpeed = 0;
            drivingGame.currentSpeed = 0;
            
            setTimeout(() => {
                if (drivingGame.active) {
                    if (drivingGame.stopsCompleted === drivingGame.totalStops) {
                        document.getElementById('gameMessage').textContent = 'üéØ ¬°Todas las paradas! Completa la ruta';
                    } else {
                        document.getElementById('gameMessage').textContent = 'Contin√∫a hacia la siguiente estaci√≥n';
                    }
                }
            }, 1500);
        }

        // Completar minijuego
        function completeDrivingGame() {
            drivingGame.active = false;
            clearInterval(drivingGame.gameInterval);
            
            const passengers = gameState.capacity;
            const baseEarnings = passengers * (1 + gameState.trainLevel * 0.5);
            const totalEarnings = baseEarnings + drivingGame.bonusEarned;
            
            gameState.money += totalEarnings;
            gameState.totalTrips++;
            gameState.totalPassengers += passengers;
            
            let message = `‚úÖ Viaje completado: +${passengers} pasajeros, +$${Math.floor(baseEarnings)}`;
            if (drivingGame.bonusEarned > 0) {
                message += ` + Bonus $${Math.floor(drivingGame.bonusEarned)} (${drivingGame.stopsCompleted} paradas)`;
            }
            
            addLogEntry(message);
            
            if (drivingGame.stopsCompleted === drivingGame.totalStops) {
                showNotification('üèÜ ¬°Perfecto! Todas las paradas completadas');
                addLogEntry('üèÜ ¬°Viaje perfecto!');
            }
            
            document.getElementById('tripProgress').style.width = '0%';
            document.getElementById('tripStatus').textContent = 'Listo para partir';
            document.getElementById('driveBtn').disabled = false;
            gameState.isOnTrip = false;
            
            updateDisplay();
            checkAchievements();
            
            setTimeout(() => closeDrivingGame(), 3000);
        }

        // Cerrar minijuego
        function closeDrivingGame() {
            if (drivingGame.active) {
                completeDrivingGame();
            }
            document.getElementById('gameOverlay').classList.remove('active');
        }

        // Control de teclado
        document.addEventListener('keydown', (e) => {
            if (!drivingGame.active) return;
            
            if (e.key === 'ArrowLeft') {
                drivingGame.keys.left = true;
                e.preventDefault();
            }
            if (e.key === 'ArrowRight') {
                drivingGame.keys.right = true;
                e.preventDefault();
            }
            if (e.key === ' ') {
                drivingGame.keys.space = true;
                e.preventDefault();
            }
            if (e.key.toLowerCase() === 'x') {
                closeDrivingGame();
                e.preventDefault();
            }
        });

        document.addEventListener('keyup', (e) => {
            if (!drivingGame.active) return;
            
            if (e.key === 'ArrowLeft') drivingGame.keys.left = false;
            if (e.key === 'ArrowRight') drivingGame.keys.right = false;
            if (e.key === ' ') drivingGame.keys.space = false;
        });

        // Auto-piloto
        function autoTrip() {
            if (gameState.money >= gameState.autoPilotCost && !gameState.autoPilot) {
                gameState.money -= gameState.autoPilotCost;
                gameState.autoPilot = true;
                gameState.moneyPerSecond = (gameState.capacity * (1 + gameState.trainLevel * 0.5)) / 5;
                
                showNotification('ü§ñ ¬°Auto-piloto activado!');
                addLogEntry('ü§ñ Auto-piloto activado');
                updateDisplay();
                
                if (!gameState.isOnTrip) startAutoTrip();
            } else if (gameState.autoPilot) {
                showNotification('‚ÑπÔ∏è Auto-piloto ya activo');
            } else {
                showNotification('‚ùå Dinero insuficiente');
            }
        }

        function startAutoTrip() {
            if (!gameState.autoPilot || gameState.isOnTrip) return;
            
            gameState.isOnTrip = true;
            document.getElementById('driveBtn').disabled = true;
            document.getElementById('tripStatus').textContent = 'ü§ñ Auto-piloto...';
            
            const tripDuration = 5000 - (gameState.speed * 10);
            const progressBar = document.getElementById('tripProgress');
            
            let progress = 0;
            const interval = setInterval(() => {
                progress += 2;
                progressBar.style.width = progress + '%';
                
                if (progress >= 100) {
                    clearInterval(interval);
                    completeAutoTrip();
                }
            }, tripDuration / 50);
        }

        function completeAutoTrip() {
            const passengers = gameState.capacity;
            const earnings = passengers * (1 + gameState.trainLevel * 0.5);
            
            gameState.money += earnings;
            gameState.totalTrips++;
            gameState.totalPassengers += passengers;
            
            addLogEntry(`ü§ñ Auto-viaje: +${passengers} pasajeros, +$${Math.floor(earnings)}`);
            
            document.getElementById('tripProgress').style.width = '0%';
            document.getElementById('tripStatus').textContent = 'Listo';
            document.getElementById('driveBtn').disabled = false;
            gameState.isOnTrip = false;
            
            updateDisplay();
            checkAchievements();
            
            if (gameState.autoPilot) setTimeout(startAutoTrip, 1000);
        }

        // Mejoras
        function upgradeSpeed() {
            if (gameState.money >= gameState.speedCost) {
                gameState.money -= gameState.speedCost;
                gameState.speed += 10;
                gameState.speedCost = Math.floor(gameState.speedCost * 1.5);
                addLogEntry(`üöÑ Velocidad: ${gameState.speed} km/h`);
                showNotification('üöÑ ¬°Velocidad mejorada!');
                updateDisplay();
            } else {
                showNotification('‚ùå Dinero insuficiente');
            }
        }

        function upgradeCapacity() {
            if (gameState.money >= gameState.capacityCost) {
                gameState.money -= gameState.capacityCost;
                gameState.capacity += 50;
                gameState.capacityCost = Math.floor(gameState.capacityCost * 1.5);
                
                if (gameState.autoPilot) {
                    gameState.moneyPerSecond = (gameState.capacity * (1 + gameState.trainLevel * 0.5)) / 5;
                }
                
                addLogEntry(`üë• Capacidad: ${gameState.capacity}`);
                showNotification('üë• ¬°Capacidad aumentada!');
                updateDisplay();
            } else {
                showNotification('‚ùå Dinero insuficiente');
            }
        }

        function upgradeTrain() {
            if (gameState.money >= gameState.trainCost) {
                gameState.money -= gameState.trainCost;
                gameState.trainLevel++;
                gameState.trainCost = Math.floor(gameState.trainCost * 2);
                gameState.stationBonus = 50 * gameState.trainLevel;
                
                if (gameState.autoPilot) {
                    gameState.moneyPerSecond = (gameState.capacity * (1 + gameState.trainLevel * 0.5)) / 5;
                }
                
                addLogEntry(`‚≠ê Tren nivel ${gameState.trainLevel}`);
                showNotification(`‚≠ê ¬°Nivel ${gameState.trainLevel}!`);
                updateDisplay();
            } else {
                showNotification('‚ùå Dinero insuficiente');
            }
        }

        function addLogEntry(text) {
            const log = document.getElementById('journeyLog');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = text;
            log.insertBefore(entry, log.firstChild);
            if (log.children.length > 20) log.removeChild(log.lastChild);
        }

        function showNotification(text) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = text;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideInRight 0.5s ease-out reverse';
                setTimeout(() => notification.remove(), 500);
            }, 2500);
        }

        function checkAchievements() {
            if (gameState.totalTrips === 10) showNotification('üèÜ 10 viajes!');
            if (gameState.totalTrips === 50) showNotification('üèÜ 50 viajes!');
            if (gameState.totalTrips === 100) showNotification('üèÜ ¬°Maquinista Experto!');
            if (gameState.totalPassengers >= 1000) showNotification('üèÜ 1000 pasajeros!');
            if (gameState.trainLevel === 5) showNotification('üèÜ Tren de Alta Tecnolog√≠a!');
        }

        setInterval(() => {
            localStorage.setItem('trainTycoonSave', JSON.stringify(gameState));
        }, 10000);

        function loadGame() {
            const saved = localStorage.getItem('trainTycoonSave');
            if (saved) {
                gameState = JSON.parse(saved);
                updateDisplay();
                addLogEntry('üíæ Juego cargado');
                if (gameState.autoPilot && !gameState.isOnTrip) startAutoTrip();
            }
        }

        loadGame();
        updateDisplay();
    </script>

        // Actualizar visualizaci√≥n
        function updateDisplay() {
            document.getElementById('money').textContent = '$' + Math.floor(gameState.money);
            document.getElementById('moneyPerSecond').textContent = '$' + gameState.moneyPerSecond.toFixed(1);
            document.getElementById('totalTrips').textContent = gameState.totalTrips;
            document.getElementById('totalPassengers').textContent = gameState.totalPassengers;
            document.getElementById('speed').textContent = gameState.speed + ' km/h';
            document.getElementById('capacity').textContent = gameState.capacity + ' pasajeros';
            document.getElementById('trainLevel').textContent = gameState.trainLevel;
            document.getElementById('speedCost').textContent = gameState.speedCost;
            document.getElementById('capacityCost').textContent = gameState.capacityCost;
            document.getElementById('trainCost').textContent = gameState.trainCost;
        }

        // Iniciar viaje (ahora abre el minijuego)
        function startTrip() {
            if (gameState.isOnTrip) return;
            
            gameState.isOnTrip = true;
            openDrivingGame();
        }

        // Abrir minijuego de conducci√≥n con circuito
        function openDrivingGame() {
            drivingGame.active = true;
            drivingGame.angle = 270; // Comenzar arriba
            drivingGame.currentSpeed = 0;
            drivingGame.targetSpeed = 0;
            drivingGame.stopsCompleted = 0;
            drivingGame.bonusEarned = 0;
            drivingGame.lapsCompleted = 0;
            
            // Calcular centro del circuito
            const track = document.getElementById('gameTrack');
            const rect = track.getBoundingClientRect();
            drivingGame.centerX = track.offsetWidth / 2;
            drivingGame.centerY = track.offsetHeight / 2;
            
            // Crear estaciones en posiciones equilibradas alrededor del circuito
            drivingGame.stations = [];
            const baseAngles = [30, 110, 190, 290]; // √Ångulos distribuidos equilibradamente
            
            for (let i = 0; i < drivingGame.totalStops; i++) {
                // A√±adir variaci√≥n aleatoria de ¬±15 grados
                const randomOffset = (Math.random() - 0.5) * 30;
                const angle = baseAngles[i] + randomOffset;
                
                drivingGame.stations.push({
                    angle: angle,
                    completed: false,
                    bonus: gameState.stationBonus * (i + 1) * gameState.trainLevel,
                    stopZone: null
                });
            }
            
            renderStations();
            
            document.getElementById('gameOverlay').classList.add('active');
            document.getElementById('gameMessage').textContent = '¬°Acelera con ‚Üí y frena con ‚Üê! Usa ESPACIO en las estaciones.';
            document.getElementById('stopsCompleted').textContent = '0/' + drivingGame.totalStops;
            document.getElementById('bonusMoney').textContent = '$0';
            document.getElementById('lapsCount').textContent = '0/' + drivingGame.totalLaps;
            
            // Iniciar loop del juego
            drivingGame.gameInterval = setInterval(updateDrivingGame, 30);
        }

        // Renderizar estaciones en el circuito
        function renderStations() {
            const track = document.getElementById('gameTrack');
            
            // Limpiar estaciones y zonas existentes
            const oldElements = track.querySelectorAll('.station, .stop-zone');
            oldElements.forEach(el => el.remove());
            
            // Crear nuevas estaciones
            drivingGame.stations.forEach((station, index) => {
                const angleRad = (station.angle * Math.PI) / 180;
                const x = drivingGame.centerX + Math.cos(angleRad) * drivingGame.circuitRadius;
                const y = drivingGame.centerY + Math.sin(angleRad) * drivingGame.circuitRadius;
                
                // Crear estaci√≥n
                const stationEl = document.createElement('div');
                stationEl.className = 'station';
                stationEl.style.left = x + 'px';
                stationEl.style.top = y + 'px';
                stationEl.style.transform = 'translate(-50%, -50%)';
                stationEl.innerHTML = `
                    <div class="station-icon">üè†</div>
                    <div class="station-label">Est. ${index + 1}</div>
                `;
                stationEl.id = 'station-' + index;
                track.appendChild(stationEl);
                
                // Crear zona de parada
                const zoneEl = document.createElement('div');
                zoneEl.className = 'stop-zone';
                zoneEl.style.left = x + 'px';
                zoneEl.style.top = y + 'px';
                zoneEl.id = 'zone-' + index;
                track.appendChild(zoneEl);
                
                station.stopZone = zoneEl;
            });
            
            // Marcar la primera estaci√≥n como siguiente
            if (drivingGame.stations.length > 0) {
                updateNextStation();
            }
        }

        // Actualizar cu√°l es la siguiente estaci√≥n
        function updateNextStation() {
            // Remover clase "next" de todas
            document.querySelectorAll('.station').forEach(s => s.classList.remove('next'));
            document.querySelectorAll('.stop-zone').forEach(z => z.classList.remove('active'));
            
            // Encontrar la siguiente estaci√≥n no completada
            const nextStation = drivingGame.stations.find(s => !s.completed);
            if (nextStation) {
                const index = drivingGame.stations.indexOf(nextStation);
                document.getElementById('station-' + index).classList.add('next');
                document.getElementById('zone-' + index).classList.add('active');
            }
        }

        // Loop del minijuego
        function updateDrivingGame() {
            if (!drivingGame.active) return;
            
            // Actualizar velocidad seg√∫n teclas
            if (drivingGame.keys.right) {
                drivingGame.targetSpeed = Math.min(drivingGame.maxSpeed, drivingGame.targetSpeed + 3);
            }
            if (drivingGame.keys.left) {
                drivingGame.targetSpeed = Math.max(0, drivingGame.targetSpeed - 3);
            }
            
            // Suavizar cambios de velocidad
            drivingGame.currentSpeed += (drivingGame.targetSpeed - drivingGame.currentSpeed) * 0.1;
            
            // Mover tren por el circuito
            drivingGame.angle += drivingGame.currentSpeed * 0.08;
            
            // Normalizar √°ngulo (0-360)
            if (drivingGame.angle >= 360) {
                drivingGame.angle -= 360;
                
                // Verificar si se complet√≥ la vuelta
                if (drivingGame.stopsCompleted === drivingGame.totalStops) {
                    drivingGame.lapsCompleted++;
                    document.getElementById('lapsCount').textContent = drivingGame.lapsCompleted + '/' + drivingGame.totalLaps;
                    
                    if (drivingGame.lapsCompleted >= drivingGame.totalLaps) {
                        completeDrivingGame();
                        return;
                    }
                }
            }
            
            // Calcular posici√≥n del tren
            const angleRad = (drivingGame.angle * Math.PI) / 180;
            const trainX = drivingGame.centerX + Math.cos(angleRad) * drivingGame.circuitRadius;
            const trainY = drivingGame.centerY + Math.sin(angleRad) * drivingGame.circuitRadius;
            
            // Actualizar sprite del tren
            const trainSprite = document.getElementById('trainSprite');
            trainSprite.style.left = trainX + 'px';
            trainSprite.style.top = trainY + 'px';
            
            // Rotar tren seg√∫n direcci√≥n
            const rotation = drivingGame.angle + 90; // +90 para que mire hacia adelante
            trainSprite.style.transform = 'translate(-50%, -50%) rotate(' + rotation + 'deg)';
            
            // Actualizar veloc√≠metro
            const displaySpeed = Math.floor(drivingGame.currentSpeed * (gameState.speed / 100));
            document.getElementById('speedDisplay').textContent = displaySpeed + ' km/h';
            document.getElementById('speedBar').style.width = drivingGame.currentSpeed + '%';
            
            // Verificar paradas en estaciones
            checkStationStop();
        }

        // Verificar si el tren est√° en una estaci√≥n
        function checkStationStop() {
            drivingGame.stations.forEach((station, index) => {
                if (station.completed) return;
                
                // Calcular diferencia angular
                let angleDiff = Math.abs(drivingGame.angle - station.angle);
                
                // Normalizar la diferencia (considerar el c√≠rculo completo)
                if (angleDiff > 180) {
                    angleDiff = 360 - angleDiff;
                }
                
                // Si est√° cerca de la estaci√≥n (dentro de ~20 grados)
                if (angleDiff < 20) {
                    // Si presiona espacio y est√° frenando
                    if (drivingGame.keys.space && drivingGame.currentSpeed < 30) {
                        stopAtStation(index);
                    } else if (drivingGame.keys.space && drivingGame.currentSpeed >= 30) {
                        document.getElementById('gameMessage').textContent = '‚ö†Ô∏è ¬°Demasiado r√°pido! Frena con ‚Üê';
                        setTimeout(() => {
                            if (drivingGame.active && !drivingGame.keys.space) {
                                document.getElementById('gameMessage').textContent = 'Contin√∫a hacia la siguiente estaci√≥n';
                            }
                        }, 1500);
                    }
                }
            });
        }

        // Parar en estaci√≥n
        function stopAtStation(index) {
            const station = drivingGame.stations[index];
            if (station.completed) return;
            
            station.completed = true;
            drivingGame.stopsCompleted++;
            drivingGame.bonusEarned += station.bonus;
            
            // Actualizar UI
            document.getElementById('stopsCompleted').textContent = drivingGame.stopsCompleted + '/' + drivingGame.totalStops;
            document.getElementById('bonusMoney').textContent = '$' + Math.floor(drivingGame.bonusEarned);
            
            const stationEl = document.getElementById('station-' + index);
            stationEl.classList.remove('next');
            stationEl.classList.add('completed');
            
            // Animaci√≥n de √©xito
            stationEl.style.transform = 'translate(-50%, -50%) scale(1.5)';
            setTimeout(() => {
                stationEl.style.transform = 'translate(-50%, -50%) scale(1)';
            }, 300);
            
            document.getElementById('gameMessage').textContent = '‚úÖ ¬°+$' + Math.floor(station.bonus) + ' ganados!';
            
            // Actualizar siguiente estaci√≥n
            updateNextStation();
            
            // Forzar detenci√≥n moment√°nea
            drivingGame.targetSpeed = 0;
            drivingGame.currentSpeed = 0;
            
            setTimeout(() => {
                if (drivingGame.active) {
                    if (drivingGame.stopsCompleted === drivingGame.totalStops) {
                        document.getElementById('gameMessage').textContent = 'üéØ ¬°Todas las paradas! Completa la vuelta';
                    } else {
                        document.getElementById('gameMessage').textContent = 'Contin√∫a hacia la siguiente estaci√≥n';
                    }
                }
            }, 1500);
        }

        // Completar minijuego
        function completeDrivingGame() {
            drivingGame.active = false;
            clearInterval(drivingGame.gameInterval);
            
            // Calcular ganancias
            const passengers = gameState.capacity;
            const baseEarnings = passengers * (1 + gameState.trainLevel * 0.5);
            const totalEarnings = baseEarnings + drivingGame.bonusEarned;
            
            gameState.money += totalEarnings;
            gameState.totalTrips++;
            gameState.totalPassengers += passengers;
            
            let message = `‚úÖ Viaje completado: +${passengers} pasajeros, +$${Math.floor(baseEarnings)}`;
            if (drivingGame.bonusEarned > 0) {
                message += ` + Bonus $${Math.floor(drivingGame.bonusEarned)} (${drivingGame.stopsCompleted} paradas)`;
            }
            
            addLogEntry(message);
            
            if (drivingGame.stopsCompleted === drivingGame.totalStops) {
                showNotification('üèÜ ¬°Perfecto! Todas las paradas completadas');
                addLogEntry('üèÜ ¬°Viaje perfecto! Todas las estaciones visitadas');
            }
            
            document.getElementById('tripProgress').style.width = '0%';
            document.getElementById('tripStatus').textContent = 'Listo para partir';
            document.getElementById('driveBtn').disabled = false;
            gameState.isOnTrip = false;
            
            updateDisplay();
            checkAchievements();
            
            // Cerrar overlay despu√©s de mostrar resultado
            setTimeout(() => {
                closeDrivingGame();
            }, 3000);
        }

        // Cerrar minijuego
        function closeDrivingGame() {
            if (drivingGame.active) {
                completeDrivingGame();
            }
            document.getElementById('gameOverlay').classList.remove('active');
        }

        // Control de teclado
        document.addEventListener('keydown', (e) => {
            if (!drivingGame.active) return;
            
            if (e.key === 'ArrowLeft') {
                drivingGame.keys.left = true;
                e.preventDefault();
            }
            if (e.key === 'ArrowRight') {
                drivingGame.keys.right = true;
                e.preventDefault();
            }
            if (e.key === ' ') {
                drivingGame.keys.space = true;
                e.preventDefault();
            }
            if (e.key.toLowerCase() === 'x') {
                closeDrivingGame();
                e.preventDefault();
            }
        });

        document.addEventListener('keyup', (e) => {
            if (!drivingGame.active) return;
            
            if (e.key === 'ArrowLeft') {
                drivingGame.keys.left = false;
            }
            if (e.key === 'ArrowRight') {
                drivingGame.keys.right = false;
            }
            if (e.key === ' ') {
                drivingGame.keys.space = false;
            }
        });

        // Activar auto-piloto
        function autoTrip() {
            if (gameState.money >= gameState.autoPilotCost && !gameState.autoPilot) {
                gameState.money -= gameState.autoPilotCost;
                gameState.autoPilot = true;
                gameState.moneyPerSecond = (gameState.capacity * (1 + gameState.trainLevel * 0.5)) / 5;
                
                showNotification('ü§ñ ¬°Auto-piloto activado!');
                addLogEntry('ü§ñ Auto-piloto activado - Los viajes ser√°n autom√°ticos (sin minijuego)');
                updateDisplay();
                
                if (!gameState.isOnTrip) {
                    startAutoTrip();
                }
            } else if (gameState.autoPilot) {
                showNotification('‚ÑπÔ∏è Auto-piloto ya est√° activo');
            } else {
                showNotification('‚ùå Dinero insuficiente');
            }
        }

        // Viaje autom√°tico (sin minijuego)
        function startAutoTrip() {
            if (!gameState.autoPilot || gameState.isOnTrip) return;
            
            gameState.isOnTrip = true;
            document.getElementById('driveBtn').disabled = true;
            document.getElementById('tripStatus').textContent = 'ü§ñ Auto-piloto en ruta...';
            
            const tripDuration = 5000 - (gameState.speed * 10);
            const progressBar = document.getElementById('tripProgress');
            
            let progress = 0;
            const interval = setInterval(() => {
                progress += 2;
                progressBar.style.width = progress + '%';
                
                if (progress >= 100) {
                    clearInterval(interval);
                    completeAutoTrip();
                }
            }, tripDuration / 50);
        }

        // Completar viaje autom√°tico
        function completeAutoTrip() {
            const passengers = gameState.capacity;
            const earnings = passengers * (1 + gameState.trainLevel * 0.5);
            
            gameState.money += earnings;
            gameState.totalTrips++;
            gameState.totalPassengers += passengers;
            
            addLogEntry(`ü§ñ Auto-viaje completado: +${passengers} pasajeros, +$${Math.floor(earnings)}`);
            
            document.getElementById('tripProgress').style.width = '0%';
            document.getElementById('tripStatus').textContent = 'Listo para partir';
            document.getElementById('driveBtn').disabled = false;
            gameState.isOnTrip = false;
            
            updateDisplay();
            checkAchievements();
            
            // Continuar con auto-piloto
            if (gameState.autoPilot) {
                setTimeout(startAutoTrip, 1000);
            }
        }

        // Mejorar velocidad
        function upgradeSpeed() {
            if (gameState.money >= gameState.speedCost) {
                gameState.money -= gameState.speedCost;
                gameState.speed += 10;
                gameState.speedCost = Math.floor(gameState.speedCost * 1.5);
                
                addLogEntry(`üöÑ Velocidad mejorada a ${gameState.speed} km/h`);
                showNotification('üöÑ ¬°Velocidad mejorada!');
                updateDisplay();
            } else {
                showNotification('‚ùå Dinero insuficiente');
            }
        }

        // Mejorar capacidad
        function upgradeCapacity() {
            if (gameState.money >= gameState.capacityCost) {
                gameState.money -= gameState.capacityCost;
                gameState.capacity += 50;
                gameState.capacityCost = Math.floor(gameState.capacityCost * 1.5);
                
                if (gameState.autoPilot) {
                    gameState.moneyPerSecond = (gameState.capacity * (1 + gameState.trainLevel * 0.5)) / 5;
                }
                
                addLogEntry(`üë• Capacidad aumentada a ${gameState.capacity} pasajeros`);
                showNotification('üë• ¬°Capacidad aumentada!');
                updateDisplay();
            } else {
                showNotification('‚ùå Dinero insuficiente');
            }
        }

        // Mejorar tren
        function upgradeTrain() {
            if (gameState.money >= gameState.trainCost) {
                gameState.money -= gameState.trainCost;
                gameState.trainLevel++;
                gameState.trainCost = Math.floor(gameState.trainCost * 2);
                gameState.stationBonus = 50 * gameState.trainLevel;
                
                if (gameState.autoPilot) {
                    gameState.moneyPerSecond = (gameState.capacity * (1 + gameState.trainLevel * 0.5)) / 5;
                }
                
                addLogEntry(`‚≠ê Tren mejorado al nivel ${gameState.trainLevel} - Bonus por parada aumentado`);
                showNotification(`‚≠ê ¬°Tren nivel ${gameState.trainLevel}!`);
                updateDisplay();
            } else {
                showNotification('‚ùå Dinero insuficiente');
            }
        }

        // Agregar entrada al registro
        function addLogEntry(text) {
            const log = document.getElementById('journeyLog');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = text;
            log.insertBefore(entry, log.firstChild);
            
            if (log.children.length > 20) {
                log.removeChild(log.lastChild);
            }
        }

        // Mostrar notificaci√≥n
        function showNotification(text) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = text;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideInRight 0.5s ease-out reverse';
                setTimeout(() => notification.remove(), 500);
            }, 2500);
        }

        // Verificar logros
        function checkAchievements() {
            if (gameState.totalTrips === 10) {
                showNotification('üèÜ ¬°Logro: 10 viajes completados!');
            }
            if (gameState.totalTrips === 50) {
                showNotification('üèÜ ¬°Logro: 50 viajes completados!');
            }
            if (gameState.totalTrips === 100) {
                showNotification('üèÜ ¬°Logro: ¬°Maquinista Experto!');
            }
            if (gameState.totalPassengers >= 1000) {
                showNotification('üèÜ ¬°Logro: 1000 pasajeros transportados!');
            }
            if (gameState.trainLevel === 5) {
                showNotification('üèÜ ¬°Logro: Tren de Alta Tecnolog√≠a!');
            }
        }

        // Auto-guardado
        setInterval(() => {
            localStorage.setItem('trainTycoonSave', JSON.stringify(gameState));
        }, 10000);

        // Cargar juego
        function loadGame() {
            const saved = localStorage.getItem('trainTycoonSave');
            if (saved) {
                gameState = JSON.parse(saved);
                updateDisplay();
                addLogEntry('üíæ Juego cargado');
                
                if (gameState.autoPilot && !gameState.isOnTrip) {
                    startAutoTrip();
                }
            }
        }

        // Inicializar
        loadGame();
        updateDisplay();
    </script>
</body>
</html>